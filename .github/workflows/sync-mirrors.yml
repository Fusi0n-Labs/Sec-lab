name: Sync security mirrors (root)

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync sources
        shell: bash
        run: |
          set -euo pipefail

          SOURCES=(
            "https://github.com/danielmiessler/SecLists.git SecLists"
            "https://github.com/swisskyrepo/PayloadsAllTheThings.git PayloadsAllTheThings"
            "https://github.com/carlospolop/PEASS-ng.git PEASS-ng"
            "https://github.com/PowerShellMafia/PowerSploit.git PowerSploit"
            "https://github.com/Proviesec/google-dorks.git google-dorks"
            "https://github.com/byt3bl33d3r/CrackMapExec.git CrackMapExec"
            "https://github.com/A-poc/RedTeam-Tools.git RedTeam-Tools"
            "https://github.com/The-Art-of-Hacking/h4cker.git h4cker"
            "https://github.com/pentestmonkey/php-reverse-shell.git php-reverse-shell"
            "https://github.com/Mebus/cupp.git cupp"
            "https://github.com/0xffsec/webdojo.git webdojo-0xffsec"
            "https://github.com/R3dy/capsulecorp-pentest.git capsulecorp-pentest"
            "https://github.com/bst04/CyberSources.git CyberSources"
            "https://github.com/HunxByts/GhostTrack.git GhostTrack"
            "https://github.com/wazuh/wazuh.git wazuh"
            "https://github.com/OISF/suricata.git suricata"
            "https://github.com/HotCakeX/Harden-Windows-Security.git Harden-Windows-Security"
            "https://github.com/decalage2/awesome-security-hardening.git awesome-security-hardening"
            "https://github.com/undergroundwires/privacy.sexy.git privacy.sexy"
            "https://github.com/coreb1t/awesome-pentest.git awesome-pentest"
            "https://github.com/OWASP/CheatSheetSeries.git OWASP-CheatSheetSeries"
            "https://github.com/paragonie/awesome-appsec.git awesome-appsec"
            "https://github.com/redhuntlabs/Awesome-Asset-Discovery.git Awesome-Asset-Discovery"
            "https://github.com/apsdehal/awesome-ctf.git awesome-ctf"
            "https://github.com/joe-shenouda/awesome-cyber-skills.git awesome-cyber-skills"
            "https://github.com/devsecops/awesome-devsecops.git awesome-devsecops"
            "https://github.com/fkie-cad/awesome-embedded-and-iot-security.git awesome-embedded-and-iot-security"
            "https://github.com/FabioBaroni/awesome-exploit-development.git awesome-exploit-development"
            "https://github.com/lirantal/awesome-nodejs-security.git awesome-nodejs-security"
            "https://github.com/0xsyr0/Awesome-Cybersecurity-Handbooks.git Awesome-Cybersecurity-Handbooks"
            "https://github.com/brootware/awesome-cyber-security-university.git awesome-cyber-security-university"
            "https://github.com/4ndersonLin/awesome-cloud-security.git awesome-cloud-security"
            "https://github.com/jaredthecoder/awesome-vehicle-security.git awesome-vehicle-security"
            "https://github.com/farhanashrafdev/90DaysOfCyberSecurity.git 90DaysOfCyberSecurity"
            "https://github.com/Hamed233/Cybersecurity-Mastery-Roadmap.git Cybersecurity-Mastery-Roadmap"
            "https://github.com/Hacking-Notes/Hacker-Roadmap.git Hacker-Roadmap"
            "https://github.com/Berkanktk/CyberSecurity.git CyberSecurity"
            "https://github.com/Jieyab89/OSINT-Cheat-sheet.git OSINT-Cheat-sheet"
            "https://github.com/0xrajneesh/Ethical-Hacking-Projects-for-beginners.git Ethical-Hacking-Projects-for-beginners"
            "https://github.com/the-akira/Computer-Science-Resources.git Computer-Science-Resources"
            "https://github.com/eMVee-NL/MindMap.git MindMap-eMVee"
            "https://github.com/Azure/azure-quickstart-templates.git azure-quickstart-templates"
            "https://github.com/yeyintminthuhtut/Awesome-Red-Teaming.git Awesome-Red-Teaming"
            "https://github.com/Lissy93/personal-security-checklist.git personal-security-checklist"
            "https://github.com/Lissy93/web-check.git web-check"
          )

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          detect_branch () {
            local url="$1"

            # 1) Branche par défaut déclarée par le remote
            local def
            def=$(git ls-remote --symref "$url" HEAD 2>/dev/null | awk '/^ref:/ {print $2}' | sed 's|refs/heads/||')

            if [ -n "${def:-}" ]; then
              echo "$def"
              return
            fi

            # 2) Tester explicitement l’existence de 'main' / 'master' en vérifiant la SORTIE
            if git ls-remote --heads "$url" main 2>/dev/null | grep -q 'refs/heads/main'; then
              echo "main"
              return
            fi
            if git ls-remote --heads "$url" master 2>/dev/null | grep -q 'refs/heads/master'; then
              echo "master"
              return
            fi

            # 3) Sinon, échouer proprement
            echo ""
          }

          changed=0

          for entry in "${SOURCES[@]}"; do
            URL=$(echo "$entry" | awk '{print $1}')
            DEST=$(echo "$entry" | awk '{print $2}')
            echo "==> $DEST from $URL"

            if ! git ls-remote "$URL" >/dev/null 2>&1; then
              echo "Skip: invalid URL"
              continue
            fi

            BRANCH="$(detect_branch "$URL")"
            if [ -z "$BRANCH" ]; then
              echo "Skip: cannot detect default branch"
              continue
            fi
            echo "Using branch: $BRANCH"

            rm -rf "$DEST" tmp_upstream || true
            git clone --depth 1 --branch "$BRANCH" "$URL" tmp_upstream

            mkdir -p "$DEST"
            rsync -a --delete --exclude='.git' tmp_upstream/ "$DEST/"
            rm -rf tmp_upstream

            if ! git diff --quiet -- "$DEST"; then
              git add "$DEST"
              git commit -m "chore(sync): update $DEST from $URL ($BRANCH)" || true
              changed=1
            else
              echo "No changes for $DEST"
            fi
          done

          if [ "$changed" -eq 1 ]; then
            git push
          else
            echo "No updates to push."
          fi
